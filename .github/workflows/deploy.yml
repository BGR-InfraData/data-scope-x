name: Deploy to EC2

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up AWS CLI
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

    - name: Install Session Manager Plugin
      run: |
        curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb"
        sudo dpkg -i session-manager-plugin.deb

    - name: Deploy to EC2
      env:
       INSTANCE_NAME: ${{ secrets.INSTANCE_NAME }}
      run: |
        set -x
        INSTANCE_ID=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=$INSTANCE_NAME" "Name=instance-state-name,Values=running" --query "Reservations[].Instances[].InstanceId" --output text)
        echo "INSTANCE_ID: $INSTANCE_ID"
        echo $?
        tar czf project.tar.gz --warning=no-file-changed --exclude='.git' --exclude='.github' .
        echo $?
        aws s3 cp project.tar.gz s3://bgr-infra/project.tar.gz
        echo $?
        aws ssm send-command \
         --instance-ids "$INSTANCE_ID" \
         --document-name "AWS-RunShellScript" \
         --comment "Deploy project" \
         --parameters commands="aws s3 cp s3://bgr-infra/project.tar.gz /home/ubuntu/project.tar.gz && tar xzf /home/ubuntu/project.tar.gz -C /home/ubuntu && cd /home/ubuntu/data-scope-x && docker-compose build && docker-compose up -d" \
         --output text
        echo $?

